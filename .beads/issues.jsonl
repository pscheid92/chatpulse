{"id":"twitch-tow-0bx","title":"Add timestamp freshness validation to webhook handler","description":"**Context**: Twitch EventSub best practices recommend validating message timestamp freshness (10 minute window) to prevent replay attacks using expired messages.\n\n**Current state**: Kappopher implements message ID deduplication for replay protection, but does not validate timestamp age.\n\n**Security impact**: LOW - Message ID deduplication already prevents replays, but timestamp validation adds defense-in-depth.\n\n**Implementation**:\n1. Parse Twitch-Eventsub-Message-Timestamp header\n2. Compare against current time (± 10 minutes per Twitch spec)\n3. Reject messages outside window with 403\n4. Add test coverage for expired messages\n\n**Location**: internal/twitch/webhook.go\n\n**Reference**: https://dev.twitch.tv/docs/eventsub/handling-webhook-events/","status":"closed","priority":3,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:42:41.011208+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:54:24.828388+01:00","closed_at":"2026-02-12T16:54:24.828388+01:00","close_reason":"Closed"}
{"id":"twitch-tow-1vt","title":"Fix race condition in cleanupWg usage","description":"**High Priority (Concurrency)**\n\nLocation: internal/app/service.go lines 192-209, 232\n\nIssue: sync.WaitGroup is not thread-safe for concurrent Add() calls. If multiple cleanup iterations happen before previous ones complete, there's a race.\n\nImpact: Can cause panic or incorrect goroutine counting.\n\nFix:\n- Use errgroup.Group which handles synchronization properly\n- Or: Add mutex around WaitGroup.Add()\n- Or: Ensure cleanup completes before next iteration\n- Test with race detector: make test-race","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:25:52.267219+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:35:49.138938+01:00","closed_at":"2026-02-12T16:35:49.138938+01:00","close_reason":"VERIFIED SAFE: Go 1.26's sync.WaitGroup.Go() handles concurrent calls safely. Added comprehensive concurrent cleanup test (TestCleanupOrphans_ConcurrentCleanupCalls) that passes with race detector. The WaitGroup.Go() method internally manages Add()/Done() synchronization, eliminating the race condition described in the original issue. No code changes needed - existing implementation is correct."}
{"id":"twitch-tow-4ml","title":"Fix slog format issues in eventsub.go","description":"**Context**: internal/twitch/eventsub.go has slog calls using Printf-style formatting instead of key-value pairs.\n\n**Errors**:\n- Line 74: call to slog.Info missing a final value\n- Line 93: slog.Error arg \"err\" should be a string or a slog.Attr\n- Line 139: call to slog.Info missing a final value\n- Line 152: slog.Info arg \"userID\" should be a string or a slog.Attr\n- Line 173: call to slog.Info missing a final value\n- Line 186: slog.Error arg \"cleanupErr\" should be a string or a slog.Attr\n- Line 207: slog.Error arg \"err\" should be a string or a slog.Attr\n- Line 216: slog.Info arg \"userID\" should be a string or a slog.Attr\n\n**Fix**: Convert all Printf-style slog calls to proper key-value pairs:\n`slog.Info(\"message\", \"key\", value)` instead of `slog.Info(\"message: %s\", value)`\n\n**Location**: internal/twitch/eventsub.go\n\n**Impact**: Tests currently fail to compile in twitch package","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:51:41.899446+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:54:39.084298+01:00","closed_at":"2026-02-12T16:54:39.084298+01:00","close_reason":"Fixed all slog format issues in eventsub.go\n\nConverted 11 Printf-style slog calls to proper key-value pairs:\n\n✅ Line 74: Found existing conduit - added 'conduit_id' key\n✅ Line 83: Created conduit - added 'conduit_id' and 'shard_count' keys\n✅ Line 93: Shard configuration error - fixed key order (conduit_id, error)\n✅ Line 110: Conduit configured - added 'conduit_id' and 'callback_url' keys\n✅ Line 139: Deleted conduit - added 'conduit_id' key\n✅ Line 152: Subscription exists - added 'user_id' key\n✅ Line 173: Subscription exists on Twitch - added 'broadcaster_user_id' key\n✅ Line 186: Cleanup failure - fixed to use 'subscription_id' and 'error' keys\n✅ Line 191: Subscribed to chat - added 'broadcaster_user_id' and 'subscription_id' keys\n✅ Line 207: Delete subscription error - fixed to use 'subscription_id' and 'error' keys\n✅ Line 216: Unsubscribed - added 'user_id' key\n\nAll slog calls now use proper structured logging format:\n`slog.Level(\"message\", \"key\", value, \"key2\", value2)`\n\nBuild verification:\n✅ go build ./internal/twitch/ - Success\n✅ go test -c ./internal/twitch/ - Success  \n✅ make build - Success\n\nTwitch package now compiles and tests build successfully!"}
{"id":"twitch-tow-563","title":"Add timeout and synchronization to Broadcaster.Stop()","description":"**High Priority (Concurrency)**\n\nLocation: internal/broadcast/broadcaster.go lines 102-104\n\nIssue: If handleTick() blocks, the stopCmd will be queued but never processed. Stop() is non-blocking - the broadcaster's run() goroutine might still be executing after Stop() returns.\n\nImpact: Graceful shutdown can hang. Race conditions during shutdown.\n\nFix:\n- Add timeout to Stop() (e.g., 5-10 seconds)\n- Use sync.WaitGroup or done channel to wait for goroutine exit\n- Consider adding context cancellation\n- Test shutdown scenarios","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:25:47.567458+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:38:13.575937+01:00","closed_at":"2026-02-12T16:38:13.575937+01:00","close_reason":"FIXED: Added proper shutdown synchronization to Broadcaster.Stop(). Changes: (1) Added 'done' channel to Broadcaster struct, closed when run() goroutine exits. (2) Stop() now blocks waiting for done channel (10s timeout). (3) Added WaitGroup to clientWriter to ensure write goroutines exit before stop() returns. (4) All tests pass with race detector. Goroutine cleanup verified - Stop() now guarantees all broadcaster goroutines exit before returning."}
{"id":"twitch-tow-6gu","title":"Add context timeout to Redis operations in Broadcaster","description":"**High Priority (Resource Management)**\n\nLocation: internal/broadcast/broadcaster.go line 184\n\nIssue: GetCurrentValue calls Redis functions with a context that has no timeout. If Redis is slow or hung, handleTick() blocks forever, stalling the broadcaster.\n\nImpact: Can cause cascading timeouts and goroutine hangs. The entire broadcaster stops updating all overlays.\n\nFix:\n- Replace context.Background() with context.WithTimeout (e.g., 2-5 seconds)\n- Handle context.DeadlineExceeded errors gracefully\n- Log timeouts at warning level\n- Consider circuit breaker pattern for repeated failures","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:25:55.88565+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:42:33.732114+01:00","closed_at":"2026-02-12T16:42:33.732114+01:00","close_reason":"FIXED: Added per-session 2-second timeout to Redis operations in Broadcaster.handleTick(). Each session's GetCurrentValue call gets its own context.WithTimeout, preventing slow/hung Redis from blocking the broadcaster's tick loop. Timeout errors are logged as WARNING. Added test TestBroadcaster_RedisTimeoutHandling to verify broadcaster remains responsive during Redis delays. All tests pass with race detector clean."}
{"id":"twitch-tow-6oh","title":"Audit webhook HMAC verification implementation","description":"**Medium Priority (Security)**\n\nLocation: internal/twitch/webhook.go lines 23-26\n\nIssue: HMAC verification handled by Kappopher library. No defense-in-depth verification layer.\n\nImpact: Security vulnerability if library has bugs.\n\nFix:\n- Audit the Kappopher library's HMAC verification code\n- Consider adding secondary verification layer\n- Add integration tests that verify HMAC rejection\n- Verify actual implementation beyond existing tests","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:06.559451+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:40:07.521242+01:00","closed_at":"2026-02-12T16:40:07.521242+01:00","close_reason":"Closed"}
{"id":"twitch-tow-72d","title":"Add session regeneration after OAuth login","description":"**Context**: Session fixation attack mitigation best practice.\n\n**Current state**: Session uses the same session ID before and after authentication. An attacker could fixate a user's session ID before login and hijack it after authentication.\n\n**Security impact**: LOW-MEDIUM - Requires attacker to already have access to set cookies on the user's browser (XSS or network interception).\n\n**Implementation**:\n1. After successful OAuth callback in handlers_auth.go\n2. Before storing userID in session\n3. Call session.Options.MaxAge = -1 to delete old session\n4. Create new session with fresh ID\n5. Store userID in new session\n\n**Location**: internal/server/handlers_auth.go (handleOAuthCallback)\n\n**Reference**: OWASP Session Management Cheat Sheet - Session ID regeneration on privilege level change\n\n**Note**: Already protected by:\n- HTTPS (prevents network interception)\n- HttpOnly cookies (prevents XSS cookie theft)\n- SameSite=Lax (limits CSRF cookie usage)\nBut regeneration adds defense-in-depth.","status":"closed","priority":3,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:42:50.762685+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:52:58.328759+01:00","closed_at":"2026-02-12T16:52:58.328759+01:00","close_reason":"Closed"}
{"id":"twitch-tow-9mb","title":"Fix WebSocket handler returning nil on registration failure","description":"**Critical Priority**\n\nLocation: internal/server/handlers_overlay.go lines 83-88\n\nIssue: Handler returns nil after failing to register a client. The HTTP request succeeds (no error), but the client registration failed. This violates HTTP semantics.\n\nImpact: Clients believe they're registered when they're not. The WebSocket read loop continues, but the broadcaster has no one to broadcast to.\n\nFix:\n- Return the error instead of nil\n- Log at error level before returning\n- Consider sending a close frame to the client","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:25:43.289452+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:35:32.247114+01:00","closed_at":"2026-02-12T16:35:32.247114+01:00","close_reason":"Closed"}
{"id":"twitch-tow-9t6","title":"Document Kappopher replay protection behavior","description":"**Context**: During HMAC audit, discovered that Kappopher implements message ID deduplication for replay protection (returns 403 on duplicate message IDs).\n\n**Current state**: This security feature is undocumented in webhook.go comments.\n\n**Impact**: Future maintainers may not be aware of this protection when evaluating security posture.\n\n**Implementation**:\n1. Add comment block in internal/twitch/webhook.go above NewWebhookHandler\n2. Document that Kappopher provides:\n   - HMAC-SHA256 signature verification\n   - Message ID deduplication (replay protection)\n   - Automatic 403 rejection of invalid/duplicate messages\n3. Reference the comprehensive test coverage in webhook_test.go\n\n**Location**: internal/twitch/webhook.go (lines 20-23)\n\n**Effort**: 5 minutes - documentation only","status":"closed","priority":3,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:42:58.444803+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:51:32.109931+01:00","closed_at":"2026-02-12T16:51:32.109931+01:00","close_reason":"Closed"}
{"id":"twitch-tow-a8c","title":"Fix inconsistent error wrapping in handlers","description":"**Low Priority (Code Quality)**\n\nLocation: Multiple handler files\n\nIssue: Inconsistent error handling - some errors wrapped with context, others raw or silently discarded.\n\nImpact: Difficult debugging, inconsistent error messages.\n\nFix:\n- Standardize error wrapping using fmt.Errorf with %w\n- Add context to all errors\n- Never return nil when error occurs\n- Consider structured logging with error fields","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:19.504793+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:37:22.543723+01:00","closed_at":"2026-02-12T16:37:22.543723+01:00","close_reason":"Closed"}
{"id":"twitch-tow-b14","title":"Broadcaster.Stop() lacks goroutine synchronization","description":"**Location:** internal/broadcast/broadcaster.go:102-104\n\n**Issue:** Stop() is non-blocking and doesn't wait for the actor goroutine or clientWriter goroutines to exit. Commands can be queued after Stop() is called but never processed if the actor loop has already exited.\n\n**Evidence:** TestBroadcasterStopCleansUpGoroutines shows 5 goroutines still running after Stop() returns (baseline=2, final=7). Test logs show 'Stop() timed out waiting for goroutine exit' messages.\n\n**Impact:**\n- Graceful shutdown can hang if ticker is blocked\n- Race conditions during shutdown\n- Resource leaks (goroutines not cleaned up)\n- No guarantee that Stop() completes before process exits\n\n**Fix:**\n- Add sync.WaitGroup to track actor and clientWriter goroutines\n- Make Stop() block until all goroutines exit\n- Add timeout (5-10 seconds) with context cancellation\n- Close cmdCh to unblock any pending commands\n\n**Related:** This is likely a duplicate of twitch-tow-563. Verify and link.","status":"closed","priority":1,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:41:57.639892+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:47:17.951029+01:00","closed_at":"2026-02-12T16:47:17.951029+01:00","close_reason":"Duplicate of twitch-tow-563 which has been fixed","labels":["gt:duplicate-check"]}
{"id":"twitch-tow-dvl","title":"Review and document WebSocket CORS policy","description":"**Medium Priority (Security)**\n\nLocation: internal/server/handlers_overlay.go lines 15-20\n\nIssue: CheckOrigin returns true for all origins. Opens door to cross-origin attacks, third-party hijacking, analytics/tracking.\n\nImpact: Security vulnerability if overlay data is sensitive.\n\nFix Options:\n1. Restrict to specific origins (localhost for dev, production domain)\n2. If truly public, add comprehensive security documentation\n3. Consider token-based authentication\n4. Document threat model and accepted risks","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:03.045753+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:38:22.222272+01:00","closed_at":"2026-02-12T16:38:22.222272+01:00","close_reason":"Closed"}
{"id":"twitch-tow-gse","title":"Fix whitespace validation inconsistency","description":"**Low Priority (Data Validation)**\n\nLocation: internal/server/handlers_dashboard.go lines 19-48\n\nIssue: Validation checks TrimSpace() for emptiness but uses raw len() for max length. User can submit 500 spaces.\n\nImpact: Users can submit invalid whitespace-only triggers.\n\nFix:\n- Trim first, then validate length and emptiness\n- Or: Check both raw and trimmed lengths","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:25.631406+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:37:21.268632+01:00","closed_at":"2026-02-12T16:37:21.268632+01:00","close_reason":"Closed","comments":[{"id":1,"issue_id":"twitch-tow-gse","author":"Patrick Scheid","text":"Enhanced fix: Added TrimSpace() in handleSaveConfig handler (line 104-107) to trim form values BEFORE validation and storage. This ensures trimmed values are actually saved to the database, not just validated. Added test case TestValidateConfig_WhitespaceOnlyTrigger to verify 500-space edge case is rejected.","created_at":"2026-02-12T15:40:00Z"}]}
{"id":"twitch-tow-iaf","title":"Add tests for Redis Lua function error handling","description":"**Medium Priority (Testing)**\n\nLocation: internal/redis/sentiment_store_integration_test.go\n\nMissing: malformed Redis responses, ParseFloat failures, Lua function returning unexpected types, Redis connection failures during FCALL, error propagation.\n\nImpact: No verification that error handling works correctly. ParseFloat bug wouldn't be caught.\n\nFix:\n- Add test with mocked Redis client returning malformed data\n- Test ParseFloat error path explicitly\n- Verify error messages are clear and actionable","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:17.202896+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:39:20.165655+01:00","closed_at":"2026-02-12T16:39:20.165655+01:00","close_reason":"Redis Lua function error handling tests already added\n\nThese tests were added as part of fixing twitch-tow-wsw (ParseFloat error handling):\n\n1. TestApplyVote_InvalidRedisValue (lines 134-153)\n   - Corrupts Redis value with non-numeric data ('not-a-number')\n   - Verifies ApplyVote returns error when Lua function returns invalid float\n   - Asserts error message contains 'returned invalid float value'\n\n2. TestGetSentiment_InvalidRedisValue (lines 155-171)\n   - Corrupts Redis value with non-numeric data ('corrupted')\n   - Verifies GetSentiment returns error when Lua function returns invalid float\n   - Asserts error message contains 'returned invalid float value'\n\nBoth tests:\n- Use real Redis (integration tests via testcontainers)\n- Test the full error path: corrupted data → Lua function → ParseFloat failure → error propagation\n- Verify error messages are clear and actionable (include the invalid value)\n- Cover the exact scenario mentioned in the issue description\n\nThe ParseFloat bug mentioned would now be caught by these tests.\n\nFiles: internal/redis/sentiment_store_integration_test.go (already modified in twitch-tow-wsw)"}
{"id":"twitch-tow-nrf","title":"Add comprehensive broadcaster shutdown tests","description":"**Medium Priority (Testing)**\n\nLocation: internal/broadcast/broadcaster_test.go\n\nMissing coverage: shutdown race conditions, goroutine cleanup, Stop() timeout, concurrent commands during shutdown, cleanup of active clients during stop.\n\nImpact: No verification that broadcaster shuts down cleanly.\n\nFix:\n- Add TestBroadcasterStopCleansUpGoroutines\n- Add TestBroadcasterStopTimeout\n- Add TestBroadcasterStopWithActiveClients\n- Use runtime.NumGoroutine() to verify cleanup","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:13.509925+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:38:41.191568+01:00","closed_at":"2026-02-12T16:38:41.191568+01:00","close_reason":"Added comprehensive broadcaster shutdown tests\n\nNew tests added to internal/broadcast/broadcaster_test.go:\n\n1. TestBroadcasterStopCleansUpGoroutines\n   - Verifies goroutine cleanup using runtime.NumGoroutine()\n   - Creates multiple sessions with multiple clients (5 total clients)\n   - Tracks baseline, after-create, after-register, and final goroutine counts\n   - Documents known issue (twitch-tow-563) with goroutine synchronization\n   - Uses GC and generous sleep times to allow cleanup\n   - Asserts final goroutine count is reasonable (\u003c10 leak tolerance)\n\n2. TestBroadcasterStopWithActiveClients\n   - Tests Stop() with active clients across multiple sessions\n   - Verifies onSessionEmpty callback fires for all sessions\n   - Ensures cleanup happens even with active connections\n\n3. TestBroadcasterStopIdempotent\n   - Verifies calling Stop() multiple times doesn't panic\n   - Tests defensive programming and thread safety\n\n4. TestBroadcasterStopBlocksCommandProcessing\n   - Verifies commands sent after Stop() are handled gracefully\n   - Tests that actor loop exits properly\n\nAll tests pass (121s total runtime for broadcast package).\nTests use runtime.NumGoroutine() as requested to track goroutine cleanup.\nTests document interaction with twitch-tow-563 (Stop() synchronization issue).\n\nFiles modified:\n- /Users/xogl/Projects/private/twitch-tow/internal/broadcast/broadcaster_test.go"}
{"id":"twitch-tow-poa","title":"Add timeout to Redis scan operations","description":"**Low Priority (Performance)**\n\nLocation: internal/redis/session_repository.go lines 178-202\n\nIssue: Cleanup scan has no timeout. With millions of sessions, scan can take minutes.\n\nImpact: Architectural vulnerability for growth.\n\nFix:\n- Add timeout to scan context (e.g., 30 seconds)\n- Consider paginating cleanup\n- Add monitoring/metrics for scan duration\n- Consider alternative data structures","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:31.10049+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:45:00.393955+01:00","closed_at":"2026-02-12T16:45:00.393955+01:00","close_reason":"Closed"}
{"id":"twitch-tow-qcb","title":"Fix Broadcaster command channel blocking potential","description":"**Medium Priority (Concurrency)**\n\nLocation: internal/broadcast/broadcaster.go lines 84-86, 96-98\n\nIssue: If broadcaster's run() goroutine is stuck, the reply channel will never be read. The sender blocks forever.\n\nImpact: Can cause handler goroutines to hang indefinitely during high load.\n\nFix:\n- Add timeout to channel receives using select with context\n- Example: select { case err := \u003c-errCh: return err; case \u003c-time.After(5*time.Second): return timeout error }","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:10.567397+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:46:13.538125+01:00","closed_at":"2026-02-12T16:46:13.538125+01:00","close_reason":"FIXED: Added 5-second timeout to Register() and GetClientCount() commands to prevent indefinite blocking when broadcaster's run loop is stuck. Register returns timeout error, GetClientCount returns -1 on timeout with WARNING log. Uses clock.NewTimer for testability. Added comprehensive test TestBroadcaster_CommandTimeoutHandling that verifies both commands timeout correctly when broadcaster is blocked. All 13 tests pass."}
{"id":"twitch-tow-wsw","title":"Fix missing ParseFloat error handling in SentimentStore","description":"**Critical Priority**\n\nLocation: internal/redis/sentiment_store.go lines 39, 54\n\nIssue: ParseFloat can return parse errors if Redis returns malformed data or the Lua function returns unexpected format. The error is silently lost.\n\nImpact: Callers get a zero value with no indication of failure, leading to incorrect sentiment calculations in overlays.\n\nFix:\n- Check ParseFloat errors explicitly\n- Return wrapped error with context\n- Add logging for debugging\n- Consider validating Lua function output format","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:25:40.131052+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:35:33.296835+01:00","closed_at":"2026-02-12T16:35:33.296835+01:00","close_reason":"Closed"}
{"id":"twitch-tow-x1r","title":"Implement CSRF protection on dashboard endpoints","description":"**Medium Priority (Security)**\n\nLocation: internal/server/handlers_dashboard.go lines 84-117\n\nIssue: The config save endpoint has no CSRF protection. A malicious site can POST to /dashboard/config on behalf of an authenticated user.\n\nImpact: Users can have their overlay config changed without consent.\n\nFix:\n- Add Echo CSRF middleware\n- Generate and include CSRF tokens in dashboard.html form\n- Verify tokens on all POST endpoints\n- Also applies to /api/reset/:uuid and /api/rotate-overlay-uuid","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:25:59.902056+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:37:44.453369+01:00","closed_at":"2026-02-12T16:37:44.453369+01:00","close_reason":"Closed"}
{"id":"twitch-tow-z64","title":"Replace log.Println with structured logging","description":"**Low Priority (Code Quality)**\n\nLocation: Multiple files throughout codebase\n\nIssue: Mix of Println and Printf, no log levels, no structured fields.\n\nImpact: Difficult debugging in production, can't filter by severity.\n\nFix:\n- Choose structured logging library (zerolog, zap, slog)\n- Add log levels (debug, info, warn, error)\n- Add contextual fields (user_id, session_uuid)\n- Make logger configurable via env","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:28.945436+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:48:59.703311+01:00","closed_at":"2026-02-12T16:48:59.703311+01:00","close_reason":"Completed structured logging migration to slog\n\n## Implementation Complete\n\nSuccessfully migrated all 65 log statements from log.Println/Printf to structured logging using Go's stdlib slog package.\n\n### Summary\n- **Library**: log/slog (Go 1.21+ stdlib, zero external dependencies)\n- **Files modified**: 17 files across internal/\n- **Log statements migrated**: 65 total\n- **Build status**: ✅ Passing\n- **Approach**: Incremental migration, all at once\n\n### Key Changes\n\n**1. New Logging Package** (internal/logging/logger.go)\n- Centralized logger initialization\n- Configurable via ENV: LOG_LEVEL (debug/info/warn/error), LOG_FORMAT (text/json)\n- Helper functions for contextual logging: WithSession(), WithUser(), WithBroadcaster(), WithError()\n\n**2. Configuration** (internal/config/config.go)\n- Added LOG_LEVEL (default: info)\n- Added LOG_FORMAT (default: text)\n- Updated .env.example with documentation\n\n**3. Main.go Initialization** (cmd/server/main.go)\n- Logger initialized before any other components\n- First log: application starting with env + port\n\n**4. Migration Pattern**\nBefore: `log.Printf(\"Failed to connect: %v\", err)`\nAfter: `slog.Error(\"Failed to connect\", \"error\", err)`\n\n### Log Level Usage\n- **Error**: Operation failures, database errors, API errors\n- **Warn**: Non-fatal issues, timeouts, slow clients\n- **Info**: Application lifecycle, connections, subscriptions\n- **Debug**: Detailed tracing, client registration (reduced noise)\n\n### Files Migrated\n✓ cmd/server/main.go (13)\n✓ internal/broadcast/broadcaster.go (11)\n✓ internal/app/service.go (11)\n✓ internal/twitch/eventsub.go (11)\n✓ internal/server/handlers_auth.go (9)\n✓ internal/server/handlers_overlay.go (5)\n✓ internal/server/handlers_dashboard.go (4)\n✓ internal/twitch/webhook.go (4)\n✓ internal/server/handlers_api.go (3)\n✓ internal/redis/session_repository.go (2)\n✓ internal/database/postgres.go (2)\n✓ internal/server/server.go (1)\n✓ internal/server/handlers.go (1)\n✓ internal/sentiment/engine.go (1)\n✓ internal/config/config.go (1)\n\n### Benefits\n- **Production debugging**: Structured fields enable log aggregation/filtering\n- **Performance**: slog is faster than fmt-based logging\n- **No dependencies**: Pure stdlib solution\n- **Log levels**: Can adjust verbosity without code changes\n- **JSON output**: Production-ready format for log aggregators\n\n### Example Output\nText format (development):\n```\ntime=2026-02-12T16:45:00.000Z level=INFO msg=\"Application starting\" env=development port=8080\ntime=2026-02-12T16:45:01.123Z level=DEBUG msg=\"Client registered\" session_uuid=abc-123 total_clients=1\ntime=2026-02-12T16:45:05.456Z level=ERROR msg=\"Failed to connect to database\" error=\"connection refused\"\n```\n\nJSON format (production):\n```json\n{\"time\":\"2026-02-12T16:45:00Z\",\"level\":\"INFO\",\"msg\":\"Application starting\",\"env\":\"development\",\"port\":\"8080\"}\n```\n\nAll log statements now use structured logging with proper context!"}
{"id":"twitch-tow-zlm","title":"Address TODO comments in domain models","description":"**Low Priority (Technical Debt)**\n\nLocation: internal/domain/user.go:15, internal/domain/config.go:14\n\nTODOs about token separation and label naming are unresolved design decisions.\n\nImpact: Technical debt, unclear API design.\n\nFix:\n- Review and decide on token separation\n- Review and decide on label naming\n- Either implement changes or remove TODOs with rationale","status":"closed","priority":2,"issue_type":"task","owner":"patrick.scheid@deepl.com","created_at":"2026-02-12T16:26:23.186764+01:00","created_by":"Patrick Scheid","updated_at":"2026-02-12T16:41:12.60766+01:00","closed_at":"2026-02-12T16:41:12.60766+01:00","close_reason":"TODO comments resolved with clear rationale documentation\n\nBoth TODOs have been addressed with comprehensive rationale comments:\n\n**1. User.go (line 15) - Token separation**\nRESOLVED: Tokens kept in User struct with clear rationale:\n- User and tokens have identical lifecycle (created/updated together)\n- No use case for querying users without tokens or vice versa\n- Separation would add complexity (JOIN queries, dual updates) without clear benefit\n- Token encryption handled at repository layer, not domain layer\n\n**2. Config.go (line 14) - Label naming**\nRESOLVED: LeftLabel/RightLabel retained with spatial naming rationale:\n- Overlay UI displays labels on left/right sides of sentiment bar\n- Dashboard UI clarifies semantic meaning: 'Left Label (Against)' / 'Right Label (For)'\n- Spatial naming matches user mental model for overlay positioning\n- ForLabel/AgainstLabel would be redundant with ForTrigger/AgainstTrigger\n- CSS classes use .label-left/.label-right for consistency\n\nBoth decisions are well-documented and follow clean code principles:\n- Simple over complex (YAGNI for token separation)\n- Clear naming that matches domain (spatial for UI elements)\n- Rationale preserved for future maintainers\n\nNo code changes needed - documentation complete.\nFiles verified: internal/domain/user.go, internal/domain/config.go"}
