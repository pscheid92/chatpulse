<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Overlay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: transparent;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Chakra Petch', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* ── Bar component ── */
        .bar-pill {
            width: 700px;
            height: 60px;
            background: rgb(10, 10, 20);
            backdrop-filter: blur(16px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            transition: border-color 0.5s ease;
        }

        .bar-pill .bar-label {
            position: relative;
            z-index: 1;
            padding-left: 18px;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.85);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
        }

        .bar-pill .bar-track {
            position: absolute;
            top: 50%;
            left: 110px;
            right: 25px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            transform: translateY(-50%);
        }

        .bar-pill .bar-fill {
            position: absolute;
            top: 50%;
            left: 110px;
            height: 10px;
            border-radius: 5px;
            transform: translateY(-50%);
            transition: opacity 0.5s ease;
            width: 0;
        }

        .bar-pill .bar-fill::after {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.85);
        }

        .bar-pill .bar-ball {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff 0%, #9147ff 100%);
            transform: translate(-50%, -50%);
            transition: opacity 0.5s ease;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 8px rgba(145, 71, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.85);
        }

        /* Positive color scheme */
        .bar-pill.positive .bar-label { color: rgba(0, 212, 255, 0.95); }
        .bar-pill.positive .bar-fill {
            background: linear-gradient(90deg, #00d4ff, #9147ff);
            box-shadow: 0 0 16px rgba(0, 212, 255, 0.4);
        }
        .bar-pill.positive .bar-fill::after {
            background: linear-gradient(135deg, #00d4ff, #9147ff);
            box-shadow: 0 0 14px rgba(0, 212, 255, 0.5);
        }

        /* Negative color scheme */
        .bar-pill.negative .bar-label { color: rgba(255, 45, 120, 0.95); }
        .bar-pill.negative .bar-fill {
            background: linear-gradient(90deg, #ff2d78, #ff6b3d);
            box-shadow: 0 0 16px rgba(255, 45, 120, 0.4);
        }
        .bar-pill.negative .bar-fill::after {
            background: linear-gradient(135deg, #ff2d78, #ff6b3d);
            box-shadow: 0 0 14px rgba(255, 45, 120, 0.5);
        }

        /* ── Combined mode overrides ── */
        .bar-pill.combined .bar-label-right {
            position: absolute;
            right: 18px;
            padding-left: 0;
            color: rgba(0, 212, 255, 0.95);
        }

        .bar-pill.combined .bar-label-left {
            color: rgba(255, 45, 120, 0.95);
        }

        .bar-pill.combined .bar-track {
            left: 110px;
            right: 110px;
        }

        .bar-pill.combined .bar-center-mark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.12);
        }

        /* ── Split view layout ── */
        .split-view {
            width: 700px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ── Status states ── */
        .bar-pill.degraded,
        .split-view.degraded .bar-pill {
            animation: borderWarn 2s ease-in-out infinite;
        }

        .bar-ball.disconnected {
            opacity: 0.4;
            animation: pulse 1.5s infinite;
        }

        .bar-ball.degraded {
            opacity: 0.6;
        }

        /* ── Status indicator ── */
        .status-indicator {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.06em;
            color: rgba(255, 255, 255, 0.5);
            display: none;
        }

        .status-indicator.visible {
            display: block;
            animation: pulse 1.5s infinite;
        }

        /* ── Animations ── */
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        @keyframes borderWarn {
            0%, 100% { border-color: rgba(255, 255, 255, 0.08); }
            50% { border-color: rgba(255, 180, 60, 0.35); }
        }

        /* ── Light theme ── */
        body.light-theme .bar-pill {
            background: rgb(240, 240, 245);
            border-color: rgba(0, 0, 0, 0.12);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        body.light-theme .bar-pill .bar-label {
            color: rgba(0, 0, 0, 0.85);
            text-shadow: none;
        }

        body.light-theme .bar-pill .bar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .bar-pill .bar-ball {
            border-color: rgba(0, 0, 0, 0.25);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.3), 0 0 6px rgba(145, 71, 255, 0.2);
        }

        body.light-theme .bar-pill.positive .bar-label { color: rgba(0, 150, 200, 0.95); }
        body.light-theme .bar-pill.positive .bar-fill { box-shadow: 0 0 10px rgba(0, 212, 255, 0.25); }
        body.light-theme .bar-pill.positive .bar-fill::after {
            border-color: rgba(0, 0, 0, 0.25);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        body.light-theme .bar-pill.negative .bar-label { color: rgba(200, 30, 90, 0.95); }
        body.light-theme .bar-pill.negative .bar-fill { box-shadow: 0 0 10px rgba(255, 45, 120, 0.25); }
        body.light-theme .bar-pill.negative .bar-fill::after {
            border-color: rgba(0, 0, 0, 0.25);
            box-shadow: 0 0 8px rgba(255, 45, 120, 0.3);
        }

        body.light-theme .bar-pill.combined .bar-label-right { color: rgba(0, 150, 200, 0.95); }
        body.light-theme .bar-pill.combined .bar-label-left { color: rgba(200, 30, 90, 0.95); }
        body.light-theme .bar-pill.combined .bar-center-mark { background: rgba(0, 0, 0, 0.1); }

        body.light-theme .status-indicator { color: rgba(0, 0, 0, 0.4); }

        @keyframes borderWarnLight {
            0%, 100% { border-color: rgba(0, 0, 0, 0.08); }
            50% { border-color: rgba(200, 140, 40, 0.4); }
        }

        body.light-theme .bar-pill.degraded,
        body.light-theme .split-view.degraded .bar-pill {
            animation: borderWarnLight 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Combined view (tug-of-war) — single bar-pill -->
        <div class="bar-pill combined" id="combined-view">
            <span class="bar-label bar-label-left">{{.AgainstLabel}}</span>
            <div class="bar-track"></div>
            <div class="bar-center-mark"></div>
            <div class="bar-ball" id="bar"></div>
            <span class="bar-label bar-label-right">{{.ForLabel}}</span>
        </div>

        <!-- Split view (two bar-pills) -->
        <div class="split-view" id="split-view" style="display:none">
            <div class="bar-pill positive">
                <span class="bar-label">{{.ForLabel}}</span>
                <div class="bar-track"></div>
                <div class="bar-fill" id="positive-fill"></div>
            </div>
            <div class="bar-pill negative">
                <span class="bar-label">{{.AgainstLabel}}</span>
                <div class="bar-track"></div>
                <div class="bar-fill" id="negative-fill"></div>
            </div>
        </div>

        <div class="status-indicator" id="status-indicator">reconnecting...</div>
    </div>

    <script src="https://unpkg.com/centrifuge@5/dist/centrifuge.js"></script>
    <script>
        const bar = document.getElementById('bar');
        const combinedView = document.getElementById('combined-view');
        const splitView = document.getElementById('split-view');
        const positiveFill = document.getElementById('positive-fill');
        const negativeFill = document.getElementById('negative-fill');
        const statusIndicator = document.getElementById('status-indicator');

        // Display state — lerps toward server values
        let displayForRatio = 0;
        let displayAgainstRatio = 0;
        let targetForRatio = 0;
        let targetAgainstRatio = 0;
        let displayMode = '{{.DisplayMode}}' || 'combined';
        let theme = '{{.Theme}}' || 'dark';
        let animFrameId = null;

        // Set initial display mode and theme
        setDisplayMode(displayMode);
        setTheme(theme);

        // Build Centrifuge WebSocket URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsURL = `${protocol}//{{.WSHost}}/connection/websocket?overlay={{.SessionUUID}}`;

        const centrifuge = new Centrifuge(wsURL, {});

        centrifuge.on('connected', function(ctx) {
            console.log('Centrifuge connected', ctx);
            bar.classList.remove('disconnected');
            bar.classList.remove('degraded');
            combinedView.classList.remove('degraded');
            splitView.classList.remove('degraded');
            statusIndicator.classList.remove('visible');
            startRenderLoop();
        });

        centrifuge.on('connecting', function(ctx) {
            console.log('Centrifuge connecting', ctx);
            bar.classList.add('disconnected');
            bar.classList.remove('degraded');
            combinedView.classList.remove('degraded');
            splitView.classList.remove('degraded');
            statusIndicator.classList.add('visible');
        });

        centrifuge.on('disconnected', function(ctx) {
            console.log('Centrifuge disconnected', ctx);
            bar.classList.add('disconnected');
            bar.classList.remove('degraded');
            combinedView.classList.remove('degraded');
            splitView.classList.remove('degraded');
            statusIndicator.classList.add('visible');
            stopRenderLoop();
        });

        // Handle publications from server-side subscription
        centrifuge.on('publication', function(ctx) {
            try {
                const data = ctx.data;

                if (data.forRatio === undefined) return;

                targetForRatio = data.forRatio;
                targetAgainstRatio = data.againstRatio;

                if (data.displayMode) {
                    setDisplayMode(data.displayMode);
                }

                if (data.theme) {
                    setTheme(data.theme);
                }

                startRenderLoop();
            } catch (error) {
                console.error('Failed to parse publication:', error);
            }
        });

        function startRenderLoop() {
            if (animFrameId !== null) return;
            function tick() {
                // Lerp toward server values
                displayForRatio += (targetForRatio - displayForRatio) * 0.15;
                displayAgainstRatio += (targetAgainstRatio - displayAgainstRatio) * 0.15;

                if (displayMode === 'split') {
                    renderSplit(displayForRatio, displayAgainstRatio);
                } else {
                    renderCombined(displayForRatio, displayAgainstRatio);
                }

                // Stop when settled near target
                const forDelta = Math.abs(targetForRatio - displayForRatio);
                const againstDelta = Math.abs(targetAgainstRatio - displayAgainstRatio);
                if (forDelta < 0.001 && againstDelta < 0.001) {
                    displayForRatio = targetForRatio;
                    displayAgainstRatio = targetAgainstRatio;
                    if (displayMode === 'split') {
                        renderSplit(displayForRatio, displayAgainstRatio);
                    } else {
                        renderCombined(displayForRatio, displayAgainstRatio);
                    }
                    animFrameId = null;
                    return;
                }
                animFrameId = requestAnimationFrame(tick);
            }
            animFrameId = requestAnimationFrame(tick);
        }

        function stopRenderLoop() {
            if (animFrameId !== null) {
                cancelAnimationFrame(animFrameId);
                animFrameId = null;
            }
        }

        function renderCombined(forRatio, againstRatio) {
            // position in [-1, 1]: forRatio - againstRatio
            const position = forRatio - againstRatio;
            // Map [-1, 1] to [17%, 83%] to keep ball within track bounds
            const percentage = 17 + ((position + 1) / 2) * 66;
            bar.style.left = `${percentage}%`;
        }

        function renderSplit(forRatio, againstRatio) {
            // Fill width relative to the track (track is from 110px to right-25px = 565px)
            positiveFill.style.width = `${forRatio * 565}px`;
            negativeFill.style.width = `${againstRatio * 565}px`;
        }

        function setDisplayMode(mode) {
            displayMode = mode;
            if (mode === 'split') {
                combinedView.style.display = 'none';
                splitView.style.display = 'flex';
            } else {
                combinedView.style.display = '';
                splitView.style.display = 'none';
            }
        }

        function setTheme(t) {
            theme = t;
            if (t === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        }

        // Initialize
        centrifuge.connect();
    </script>
</body>
</html>
